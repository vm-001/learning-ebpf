# 什么是 eBPF，为什么它很重要？

eBPF 是一项革命性的内核技术，它允许开发人员编写可动态加载到内核的自定义代码，从而改变内核的行为。

这项技术使得新一代的高性能网络、可观测性和安全工具成为可能。如果你想用基于 eBPF 的工具来观测应用程序，你不需要对应用程序做任何修改或重新配置，这要归功于 eBPF 在内核中的优势。

通过 eBPF 你可以实现：

-   几乎在系统任何方面的 performance tracing
-   具备可见性的高性能网络
-   检测并阻止恶意活动

要了解 eBPF 的历史得从 Berkeley Packet Filter 说起。

## eBPF 的起源：伯克利包过滤器

我们今天所说的 eBPF 起源于 BSD 包过滤器，它最早是在 1993 年由劳伦斯伯克利国家实验室的 Steven McCanne 和 Van Jacobson 撰写的一篇论文中描述的。这篇论文讨论了一种可以运行过滤器的伪机器，是一种用来决定是否接受或拒绝网络数据包的程序。这些程序是用 BPF 指令集编写的，一种通用的 32 位指令集，与汇编语言非常相似。这里有一个直接摘自那篇论文的例子：

```
ldh     [12]
jeq     #ETHERTYPE IP, L1, L2
L1: ret #TRUE
L2: ret #0
```



TODO



## 从 BPF 到 eBPF

从 2014 年的内核版本 3.18 开始，BPF 才演变成我们所说的 “extended BPF” 或者 “eBPF”。主要包含几个显著的改动：

-   为了在 64 位机器上更加高效，BPF 的指令集被彻底改造，而且解释器也被完全重写。
-   引入 maps 数据结构用于被 BPF 程序和用户空间(user space)程序访问，且允许信息在两者之间共享。
-   增加 `bpf()` 系统调用用于用户空间的程序与内核中的 eBPF 程序交互。
-   增加一些 BPF helper 函数。
-   新增 eBPF 验证器用于确保 eBPF 程序可以安全运行。

这为 eBPF 奠定了基础，但 eBPF 的开发并没有放缓！从那时起，eBPF有了显著的发展。





